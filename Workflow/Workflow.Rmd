---
author: "Hector Roux de BÃ©zieux"
date: '`r format(Sys.time(), "%d %B , %Y")`'
title: 'Dune workflow on the baron dataset'
output:
  html_document:
    toc: true
    toc_float: TRUE
    toc_depth: 2
    number_sections: true
    code_download: TRUE
---

```{r load packages, include=F}
library(knitr)
opts_chunk$set(
  fig.pos = "!h", out.extra = "", warning = F, message = F,
  fig.align = "center", echo = F
)
NCORES <- 2
```

# Load data

We download the data from segerstolpe et al, hosted [here]

```{r}
library(SingleCellExperiment)
library(stringr)
sce <- readRDS(url("https://scrnaseq-public-datasets.s3.amazonaws.com/scater-objects/segerstolpe.rds"))
sce <- sce[, sce$cell_quality == "OK"]
filt <- rowSums(counts(sce) >= 5) >= 20
sce <- sce[filt, ]
sce$batch <- word(colnames(sce), 1, sep = "_") %>% unlist()
sce
rm(filt)
```

# Pre-processing

The dataset can be normalized using ZinbWave 

```{r}
library(zinbwave)
library(Seurat)
library(BiocParallel)
pre_process_time <- system.time({
  se <- CreateSeuratObject(counts = counts(sce),
                           min.cells = 0,
                           min.features = 0,
                           project = "de")
  se <- AddMetaData(se, as.data.frame(colData(sce)))
  se <- NormalizeData(se, verbose = FALSE)
  se <- FindVariableFeatures(se, selection.method = 'vst', nfeatures = 2000,
                             verbose = FALSE)
  se <- se[VariableFeatures(se), ]
  sce <- as.SingleCellExperiment(se)
})
BPPARAM <- bpparam()
BPPARAM$workers <- NCORES
zinb_time <- system.time({
  var_genes <- rownames(sce)[rowData(sce)$vst.variable]
  sce <- zinbwave(sce, K = 10, X = "~batch", BPPARAM = BPPARAM,
                  normalizedValues = TRUE, which_genes = var_genes)
})
```
We can visualize the data using the labels from the original publication

```{r}
library(scater)
sce <- runTSNE(sce, dimred = "zinbwave")
plotTSNE(sce, colour_by = "cell_type1")
plotTSNE(sce, colour_by = "batch")
```

# Creating inputs to Dune
## sc3

```{r}
library(SC3)
sc3_time <- system.time({
  sce_sc3 <- sce
  rowData(sce_sc3)$feature_symbol <- rownames(sce_sc3)
  counts(sce_sc3) <- as.matrix(counts(sce_sc3))
  logcounts(sce_sc3) <- as.matrix(logcounts(sce_sc3))
  sce_sc3 <- sc3_estimate_k(sce_sc3)
  K <- metadata(sce_sc3)$sc3$k_estimation
  # Note: with R >= 4.0, RStudio and Mac OS, this can fails. 
  # A workaround is running 
  # parallel:::setDefaultClusterOptions(setup_strategy = "sequential")
  sce_sc3 <- sc3(sce_sc3, ks = K, n_cores = 2, rand_seed = 786907)
  sce$SC3 <- colData(sce_sc3)[, paste0("sc3_", K, "_clusters")] %>% as.factor()
})
plotTSNE(sce, colour_by = "SC3")
```

## Seurat 

```{r}
seurat_time <- system.time({
  se <- RunPCA(se, verbose = FALSE)
  se <- FindNeighbors(se, verbose = FALSE)
  se <- FindClusters(object = se, verbose = FALSE)
  sce$seurat <- Idents(se)
})
plotTSNE(sce, colour_by = "seurat")
```

## Seurat with Zinbwave

```{r}
seurat_zinb_time <- system.time({
  seu <- as.Seurat(x = sce, counts = "counts", data = "counts")
  seu <- FindNeighbors(seu, reduction = "zinbwave", verbose = FALSE)
  seu <- FindClusters(object = seu, verbose = FALSE)
  sce$seurat_zinb <- Idents(seu)
})
plotTSNE(sce, colour_by = "seurat_zinb")
```

# Running Dune

```{r}
library(Dune)
df <- colData(sce)[, c("SC3", "seurat", "seurat_zinb")] %>%
  as.matrix()
dune_time <- system.time(
  merger <- Dune(clusMat = df, BPPARAM = BPPARAM, metric = "NMI")
)
```

```{r}
plotPrePost(merger)
NMItrend(merger)
```

```{r}
plotNMIs(merger$initialMat)
plotNMIs(merger$currentMat)
```

# Picking the final clustering result to use
## Visual pick

```{r}
sce$seurat_Final <- as.factor(merger$currentMat$seurat)
plotTSNE(sce, colour_by = "seurat_Final")
```

```{r}
sce$seurat_zinb_Final <- as.factor(merger$currentMat$seurat_zinb)
plotTSNE(sce, colour_by = "seurat_zinb_Final")
```

```{r}
sce$SC3_Final <- as.factor(merger$currentMat$SC3)
plotTSNE(sce, colour_by = "SC3_Final")
```

## Picking based on sihouette

```{r}
library(cluster)
dist_mat <- dist(as.matrix(reducedDim(sce, "zinbwave")))
sils <- lapply(merger$currentMat %>% as.data.frame, function(label){
  silhouette(label, dist = dist_mat)[,3] %>%  mean()
}) %>% unlist()
sils
```

# Runtimes

```{r}
times <- c(pre_process_time[1],
           zinb_time[1],
           sc3_time[1],
           seurat_time[1],
           seurat_zinb_time[1],
           dune_time[1])
names(times) <- c("Pre-Process",
                  "Zinbwave",
                  "Sc3",
                  "Seurat",
                  "Seurat after Zinbwave",
                  "Dune")
df <- data.frame(times = times,
                 Name = factor(names(times), levels = names(times)))
ggplot(df, aes(x = Name, y = times, fill = Name)) +
  geom_col() +
  theme_classic() +
  labs(x = "Step", y = "Time (second)") +
  scale_color_brewer(palette = "Dark2")
```